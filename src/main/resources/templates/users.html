<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('users', ${commitVersion}, 'Three 60 Feedback Users')}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container">
    <div class="card shadow-sm p-4 border-0">
        <div class="card-body">
            <h1 class="mb-4">Start a Feedback Round</h1>

            <!-- Flash message -->
            <div th:if="${message}" class="alert alert-primary mb-4" th:text="${message}"></div>

            <!-- Search input -->
            <div class="mb-4" th:if="${#authorization.expression('hasRole(''COACH'')')}">
                <div class="input-group">
                    <input type="text" id="emailSearch" class="form-control" placeholder="🔍 Search by email...">
                    <button type="button" id="clearSearch" class="btn" aria-label="Clear search">×</button>
                </div>
            </div>

            <!-- User table -->
            <div th:if="${users.size() > 0}">
                <div class="table-responsive">
                    <table class="table table-striped align-middle">
                        <thead class="table-light">
                        <tr>
                            <th scope="col">User Email</th>
                            <th scope="col">Action</th>
                        </tr>
                        </thead>
                        <tbody id="userTableBody">
                        <tr th:each="user : ${users}">
                            <td th:text="${user.email}"></td>
                            <td>
                                <a class="btn btn-outline-primary btn-sm rounded"
                                   th:href="@{/users/{userId}/feedback_round(userId=${user.id},requestId=${requestId})}">
                                    Start Feedback Round
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Empty state -->
            <div th:if="${users.size() < 1}" class="text-muted">
                No users available to start a round.
            </div>
        </div>
    </div>
</div>
<div th:replace="~{fragments/footer :: footer(${commitVersion})}"></div>
<script>
    document.getElementById('emailSearch')?.addEventListener('input', function () {
        const query = this.value.toLowerCase();
        const rows = document.querySelectorAll('#userTableBody tr');

        rows.forEach(row => {
            const email = row.querySelector('td').innerText.toLowerCase();
            row.style.display = email.includes(query) ? '' : 'none';
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('emailSearch');
        const clearButton = document.getElementById('clearSearch');
        const rows = document.querySelectorAll('#userTableBody tr');

        function filterRows() {
            const query = searchInput.value.toLowerCase();
            rows.forEach(row => {
                const email = row.querySelector('td').innerText.toLowerCase();
                row.style.display = email.includes(query) ? '' : 'none';
            });
        }

        searchInput?.addEventListener('input', filterRows);

        clearButton?.addEventListener('click', () => {
            searchInput.value = '';
            filterRows();
            searchInput.focus();
        });
    });
</script>
</body>
</html>